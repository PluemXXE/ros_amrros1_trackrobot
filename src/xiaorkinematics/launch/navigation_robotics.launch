<launch>
    <!-- ======================= Arguments ======================= -->
    
    <!-- Argument to specify the map file to use -->
    <arg name="map_file" default="$(find xiaorkinematics)/maps/my_map.yaml"/>

    <!-- ======================= Map Server ======================= -->
    
    <!-- Run the map server to load the pre-made map -->
    <node name="map_server" pkg="map_server" type="map_server" args="$(arg map_file)" />

    <!-- ======================= Robot Model & TF ======================= -->
    <param name="robot_description"
           command="$(find xacro)/xacro '$(find transbot_description)/urdf/transbot_base_only.urdf.xacro'"/>

    <node name="robot_state_publisher" pkg="robot_state_publisher" type="robot_state_publisher"/>

    <node pkg="tf" type="static_transform_publisher" name="base_link_to_laser"
          args="0.0484 0 0.10403 0 0 0 /base_link /laser 30"/>

    <!-- ======================= Robot Drivers & Sensors ======================= -->
    <node pkg="xiaorkinematics" type="move_base_node" name="odometry_publisher_node" output="screen">
        <param name="linear_scale" value="1.0"/>
    </node>

    <node name="rplidarNode" pkg="rplidar_ros" type="rplidarNode" output="screen">
        <param name="serial_port" type="string" value="/dev/ttyUSB0"/>
        <param name="serial_baudrate" type="int" value="115200"/>
        <param name="frame_id" type="string" value="laser"/>
    </node>
    <node pkg="laser_filters" type="scan_to_scan_filter_chain" name="laser_filter">
        <rosparam command="load" file="$(find xiaorkinematics)/config/nav/laser_filter_config.yaml" />
        <remap from="scan" to="scan_filtered"/> <!-- ตั้งชื่อ Topic ขาออกที่กรองแล้ว -->
        <remap from="scan_filtered" to="scan"/> <!-- **Trick สำคัญ: เปลี่ยนชื่อกลับเป็น /scan** -->
    </node>
    <!-- ======================= Localization (AMCL) ======================= -->
    
    <!-- AMCL node for localization in the map -->
    <node pkg="amcl" type="amcl" name="amcl" output="screen">
        <!-- Load AMCL parameters from a config file if you have one -->
        <!-- <rosparam file="$(find xiaorkinematics)/config/nav/amcl_params.yaml" command="load" /> -->
        <param name="odom_frame_id" value="odom"/>
        <param name="base_frame_id" value="base_footprint"/>
        <param name="global_frame_id" value="map"/>
        <param name="use_map_topic" value="true"/>
        <!-- Other AMCL parameters can be set here -->
        <param name="min_particles" value="500"/>
        <param name="max_particles" value="3000"/>
        <param name="update_min_d" value="0.2"/>
        <param name="update_min_a" value="0.5"/>
        <param name="laser_max_beams" value="30"/>
        <param name="laser_z_hit" value="0.95"/>
        <param name="laser_z_rand" value="0.05"/>
    </node>

    <!-- ======================= Path Planning (move_base) ======================= -->
    
    <!-- The move_base node, the heart of the navigation stack -->
    <node pkg="move_base" type="move_base" respawn="false" name="move_base" output="screen">
        <!-- Load all the configuration files you created -->
        <rosparam file="$(find xiaorkinematics)/config/nav/costmap_common_params.yaml" command="load" ns="global_costmap" />
        <rosparam file="$(find xiaorkinematics)/config/nav/costmap_common_params.yaml" command="load" ns="local_costmap" />
        <rosparam file="$(find xiaorkinematics)/config/nav/local_costmap_params.yaml" command="load" />
        <rosparam file="$(find xiaorkinematics)/config/nav/global_costmap_params.yaml" command="load" />
        <rosparam file="$(find xiaorkinematics)/config/nav/base_local_planner_params.yaml" command="load" />
    </node>

    <!-- ======================= Visualization ======================= -->
    <node name="rviz" pkg="rviz" type="rviz" args="-d $(find xiaorkinematics)/rviz/navigation_.rviz" required="true" />

</launch>
